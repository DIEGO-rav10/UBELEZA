<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Motorista v4.20.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #0a84ff;
            --primary-hover: #007aff;
            --secondary-color: #5e5ce6;
            --secondary-hover: #4e4ac8;
            --danger-color: #ff453a;
            --danger-hover: #ff3028;
            --success-color: #30d158;
            --success-hover: #28bd4f;
            --warning-color: #ffd60a;
            --info-color: #64d2ff;
            --neon-orange: #ff9f0a;

            --bg-dark-primary: #1c1c1e;
            --bg-dark-secondary: #2c2c2e;
            --bg-dark-tertiary: #3a3a3c;
            --glass-bg: rgba(44, 44, 46, 0.7);

            --text-color-light: #ffffff;
            --text-color-medium: #b0b0b5;
            --text-color-dark: #1c1c1e;
            --text-color-disabled: #636366;
            --text-color-summary-label: #b0b0b5;

            --border-color-light: rgba(255, 255, 255, 0.15);
            --border-color-medium: rgba(255, 255, 255, 0.3);
            --border-radius: 10px;
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            --box-shadow-light: 0 4px 10px rgba(0, 0, 0, 0.2);

            --tooltip-bg: #111;
            --tooltip-text: #eee;
            --tooltip-font-size: 0.9em;

            --white: #fff;
            --overlay-color: rgba(0, 0, 0, 0.7);
            --icon-color: var(--text-color-medium);

            --total-color: #B5E61D; /* Cor Verde-Limão para Total */
            --average-color: #FF7F27; /* Cor Laranja para Média */
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 25px;
            background-color: var(--bg-dark-primary);
            line-height: 1.6;
            color: var(--text-color-light);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3 { text-align: center; color: var(--text-color-light); margin-bottom: 15px; font-weight: 600;}
        h1 {
            margin-bottom: 40px;
            font-size: 2.3em;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-shadow: 0 0 5px var(--primary-color);
        }
        h1 .version { font-size: 0.45em; color: var(--text-color-medium); font-weight: 400; text-shadow: none; }
        h2 {
            margin-bottom: 30px;
            font-size: 1.7em;
            border-bottom: 1px solid var(--border-color-light);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--text-color-light);
        }
        h2 i { color: var(--primary-color); }
        h3 { text-align: left; margin-bottom: 20px; font-size: 1.3em; display: flex; align-items: center; gap: 10px; color: var(--text-color-medium);}
        h3 i { color: var(--secondary-color); }

        .main-container { display: flex; gap: 35px; flex-wrap: wrap; margin-bottom: 40px; }
        .column {
            flex: 1;
            min-width: 360px;
            background-color: var(--bg-dark-secondary);
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color-light);
        }

        .input-group { margin-bottom: 25px; display: flex; flex-direction: column; position: relative;}
        .input-group-row { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .input-group-row .input-wrapper { flex: 1; min-width: 130px; }
        .label-with-edit { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .label-with-edit label { margin-bottom: 0; }
        .input-group label, .input-wrapper label, .input-group-row label, .races-display label {
            font-weight: 500;
            color: var(--text-color-medium);
            font-size: 0.9em;
            margin-bottom: 5px;
            display: block;
        }
        input[type="number"], select {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--border-color-light);
            border-radius: var(--border-radius);
            font-size: 1.0em;
            line-height: 1.5;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
            background-color: var(--bg-dark-tertiary);
            color: var(--text-color-light);
        }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        input[type="number"]:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.4);
        }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"]:disabled, select:disabled {
            background-color: var(--bg-dark-secondary);
            cursor: not-allowed;
            opacity: 0.6;
            color: var(--text-color-disabled);
            border-color: var(--border-color-light);
        }
        input::placeholder { color: var(--text-color-disabled); }

        /* --- Área de Ganhos Atualizados --- */
         .column.ganhos .races-display { /* Estilo específico para .races-display no topo */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--bg-dark-tertiary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color-light);
            min-width: 100px;
            text-align: center;
            margin-bottom: 25px; /* Espaço abaixo da contagem de corridas */
        }
        .column.ganhos .races-display label {
             margin-bottom: 3px;
             font-size: 0.8em;
             text-transform: uppercase;
             color: var(--text-color-medium);
             line-height: 1.2;
        }
        .column.ganhos .races-display .summary-value {
            font-size: 1.9em; /* Tamanho original para contagem de corridas */
            font-weight: 700;
            color: var(--text-color-light);
            line-height: 1.1;
        }
        .column.ganhos .input-wrapper { /* Garante margem abaixo do input */
             margin-bottom: 25px;
        }
        .column.ganhos .period-summary-inline { /* Ajusta margens para o novo contexto */
            margin-top: 0; /* Remove margem superior */
            margin-bottom: 25px; /* Mantém espaço antes do botão */
            display: flex; /* Garante o lado a lado por padrão */
            flex-direction: row; /* Garante explicitamente a direção linha (padrão, mas seguro) */
            justify-content: space-around; /* Espaça os itens */
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color-light);
            padding: 20px 15px;
            border-radius: var(--border-radius);
            text-align: center;
            flex-wrap: nowrap; /* Impede que quebrem a linha se o espaço for mínimo */
        }
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0; /* Permite que os itens encolham */
        }
        .summary-item .summary-label {
            font-size: 0.9em;
            color: var(--text-color-summary-label);
            line-height: 1.3;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .summary-item .summary-value { /* Estilo base para outros summary-values */
            font-size: 2.1em; /* Tamanho original que será sobreposto */
            line-height: 1.1;
            font-weight: 700;
            white-space: nowrap;
        }

        /* >>> MODIFICAÇÃO ANTERIOR: Reduzir fonte do Total e Média <<< */
        #period-earnings-display,
        #period-average-display {
            font-size: 1.7em; /* Reduzido ~20% (era 2.1em) */
        }
        /* >>> FIM DA MODIFICAÇÃO ANTERIOR <<< */

        #period-earnings-display {
            color: var(--total-color); /* Cor específica para Total */
        }
        #period-average-display {
            color: var(--average-color); /* Cor específica para Média */
        }
        /* --- Fim Ganhos Atualizados --- */

        button {
            display: inline-flex; align-items: center; justify-content: center; gap: 10px;
            padding: 14px 22px;
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            font-size: 1.0em;
            font-weight: 600;
            margin-top: 15px;
            box-shadow: var(--box-shadow-light);
            width: 100%;
            position: relative;
            background-color: var(--primary-color);
        }
        button:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        button:active { transform: translateY(1px); }
        button:disabled {
             background-color: var(--bg-dark-tertiary) !important;
             color: var(--text-color-disabled) !important;
             cursor: not-allowed;
             box-shadow: none;
        }
        button:disabled:hover { opacity: 1; }

        #start-new-cycle-btn { background-color: var(--success-color); }
        #start-new-cycle-btn:hover { background-color: var(--success-hover); }
        #finalize-cycle-btn { background-color: var(--secondary-color); margin-bottom: 20px; }
        #finalize-cycle-btn:hover { background-color: var(--secondary-hover); }
        #finalize-cycle-btn.hidden, #start-new-cycle-btn.hidden { display: none; }
        #add-total-earning-btn, #add-expense-btn, #simulate-cost-btn { background-color: var(--primary-color); }
        #add-total-earning-btn:hover, #add-expense-btn:hover, #simulate-cost-btn:hover { background-color: var(--primary-hover); }
        #add-total-earning-btn:disabled:hover { background-color: var(--bg-dark-tertiary) !important; }
        #add-total-earning-btn { /* Garante que o botão Atualizar ocupe a largura */
             margin-top: 0; /* Resetar margem superior padrão de botão */
        }

        .history-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 30px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        .history-controls h3 { margin-bottom: 0;}
        .secondary-toggle-btn,
        #toggle-history-btn, #archive-history-btn, #toggle-expense-history-btn {
            background-color: var(--bg-dark-tertiary);
            color: var(--text-color-medium);
            border: 1px solid var(--border-color-light);
            padding: 8px 16px; font-size: 0.9em; font-weight: 500; margin-top: 0; width: auto; box-shadow: none;
        }
        #archive-history-btn {
            background-color: var(--danger-color);
            color: var(--white);
            border: none;
         }
        .secondary-toggle-btn:hover,
        #toggle-history-btn:hover, #toggle-expense-history-btn:hover {
            background-color: var(--bg-dark-primary);
            color: var(--text-color-light);
         }
        #archive-history-btn:hover { background-color: var(--danger-hover); }

        #earnings-table, #expenses-table {
            width: 100%; border-collapse: collapse; margin-top: 0;
            border: 1px solid var(--border-color-light);
            border-radius: var(--border-radius); overflow: hidden;
            background-color: var(--bg-dark-secondary);
        }
        #earnings-table.hidden, #expenses-table.hidden, #cycle-content-wrapper.hidden { display: none; }
        #earnings-table th, #earnings-table td, #expenses-table th, #expenses-table td {
            border-bottom: 1px solid var(--border-color-light);
            padding: 12px 15px;
            text-align: left; vertical-align: middle;
            color: var(--text-color-light);
        }
        #earnings-table th, #expenses-table th {
            background-color: var(--bg-dark-tertiary);
            font-weight: 600; border-bottom-width: 2px; border-bottom-color: var(--border-color-medium);
            color: var(--text-color-medium);
            text-transform: uppercase; font-size: 0.85em;
        }
        #earnings-table td, #expenses-table td { background-color: transparent; }
        #earnings-table tbody tr:nth-child(even) td, #expenses-table tbody tr:nth-child(even) td { background-color: rgba(0,0,0, 0.1); }
        #earnings-table tbody tr:last-child td, #expenses-table tbody tr:last-child td { border-bottom: none; }
        #earnings-table td:nth-child(2), #expenses-table td:nth-child(3) { text-align: right; font-weight: 500; color: var(--success-color); }
        #expenses-table td:nth-child(2) { font-size: 0.9em; color: var(--text-color-medium); text-align: left;}
        #earnings-table .actions-cell, #expenses-table .actions-cell { text-align: center; white-space: nowrap; width: 1%;}
        .action-btn {
            background: none; border: none; color: var(--icon-color); padding: 5px 8px; cursor: pointer;
            font-size: 1em; margin: 0 3px; border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            width: 34px; height: 34px; box-shadow: none; margin-top: 0;
            display: inline-flex; align-items: center; justify-content: center; position: relative;
        }
        .action-btn:hover { background-color: var(--bg-dark-tertiary); }
        .edit-btn:hover { color: var(--primary-color); }
        .delete-btn:hover { color: var(--danger-color); }
        .action-btn i { pointer-events: none; }

        .summary {
            margin-top: 15px; padding: 14px 20px; border: 1px solid var(--border-color-light);
            border-radius: var(--border-radius); font-weight: 600;
            display: flex; justify-content: space-between; align-items: center; font-size: 1.0em;
            background-color: var(--bg-dark-tertiary);
            box-shadow: none;
            border-left-width: 5px;
        }
        .summary i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.1em; }
        .summary span:last-child { font-weight: bold; }
        .summary > span:first-of-type { display: flex; align-items: center; flex-grow: 1; }
        .summary .summary-label { flex-shrink: 0; margin-right: 8px; color: var(--text-color-medium); font-weight: 500; }
        .summary .summary-value { flex-grow: 1; text-align: right; color: var(--text-color-light); }
        .summary .summary-value.na { color: var(--text-color-disabled); font-style: italic; font-weight: normal;}

        .gasto-registrado { border-left-color: var(--danger-color); }
        .gasto-registrado i { color: var(--danger-color); }
        .outras-despesas { border-left-color: var(--secondary-color); opacity: 0.9; }
        .outras-despesas i { color: var(--secondary-color); }
        .lucro {
            border-left-color: var(--warning-color);
            background-color: rgba(255, 214, 10, 0.1);
            font-size: 1.1em; padding: 18px 22px;
        }
        .lucro i { color: var(--warning-color); }
        .lucro span:last-child { font-weight: 700; font-size: 1.1em; }
        .lucro.positivo span:last-child { color: var(--success-color); text-shadow: 0 0 3px var(--success-color); }
        .lucro.negativo span:last-child { color: var(--danger-color); text-shadow: 0 0 3px var(--danger-color); }
        .km-rodados, .corridas { border-left-color: var(--info-color); }
        .km-rodados i, .corridas i { color: var(--info-color); }
        .calculos-extra { border-left-color: var(--success-color); }
        .calculos-extra i { color: var(--success-color); }
        .calculos-extra span:last-child { color: var(--success-color); }

        .edit-summary-btn {
            background: none; border: none; color: var(--icon-color); padding: 0 5px; margin-left: 10px;
            cursor: pointer; font-size: 0.9em; vertical-align: middle; display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; border-radius: 50%; margin-top: 0; box-shadow: none; flex-shrink: 0; position: relative;
        }
        .edit-summary-btn:hover { background-color: var(--bg-dark-primary); color: var(--primary-color); }
        .edit-summary-btn.hidden { display: none; }

        #cost-simulator {
            margin-top: 35px; padding: 25px; background-color: var(--bg-dark-tertiary);
            border: 1px solid var(--border-color-light); border-radius: var(--border-radius);
        }
        #cost-simulator h3 { margin-bottom: 20px; font-size: 1.15em; color: var(--text-color-medium);}
        #cost-simulator .input-group-row { margin-bottom: 20px; }
        #cost-simulator button { width: auto; font-size: 0.95em; padding: 12px 20px; margin-top: 0; }
        #simulation-result {
            margin-top: 20px; font-weight: bold; text-align: center; font-size: 1.1em;
            color: var(--primary-color); min-height: 1.6em; text-shadow: 0 0 3px var(--primary-color);
        }
        #simulation-result .source-info { font-size: 0.8em; color: var(--text-color-medium); display: block; margin-top: 5px; text-shadow: none; }

        #chart-container, #archived-chart-container {
            margin-top: 35px; position: relative; width: 100%;
            background: var(--bg-dark-secondary);
            padding: 20px; border-radius: var(--border-radius);
            box-shadow: none;
            border: 1px solid var(--border-color-light);
        }
        #chart-container { height: 320px; }
        #archived-chart-container { height: 420px; }
        #profitChart, #archivedStatsChart { max-width: 100%; max-height: 100%; }
        .chartjs-legend ul li span { color: var(--text-color-light); }
        .chartjs-tooltip { background: var(--tooltip-bg) !important; color: var(--tooltip-text) !important; }
        .chartjs-tooltip-key { background: var(--tooltip-bg) !important; border-color: var(--tooltip-bg) !important;}
        .chartjs-title { color: var(--text-color-light) !important; }
        .chartjs-scale-ticks, .chartjs-scale-title { color: var(--text-color-medium) !important; }

        .archived-section {
            background-color: var(--bg-dark-secondary);
            padding: 35px; border-radius: var(--border-radius); box-shadow: var(--box-shadow);
            margin-top: 40px; margin-bottom: 40px; border: 1px solid var(--border-color-light);
        }
        .archived-section h2 { color: var(--text-color-light); }
        #archived-list { margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); gap: 30px; }
        .archive-item {
            border: 1px solid var(--border-color-light); border-radius: var(--border-radius); padding: 0;
            background-color: var(--bg-dark-tertiary);
            box-shadow: var(--box-shadow-light); position: relative; transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .archive-item:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.4); transform: translateY(-3px); }
        .archive-item-content { padding: 25px; cursor: pointer; position: relative; }
        .archive-item p { margin: 10px 0; font-size: 1.0em; display: flex; align-items: flex-start; color: var(--text-color-light); }
        .archive-item p i { margin-right: 12px; color: var(--icon-color); width: 18px; text-align: center; margin-top: 3px; flex-shrink: 0; }
        .archive-item p strong { font-weight: 600; display: inline-block; min-width: 115px; color: var(--text-color-medium); flex-shrink: 0; }
        .archive-item .archive-note { font-style: italic; color: var(--text-color-medium); font-size: 0.95em; margin-left: calc(18px + 12px); display: block; }
        .archive-item .profit-value { font-weight: 700; font-size: 1.1em;}
        .archive-item .profit-value.positive { color: var(--success-color); text-shadow: 0 0 3px var(--success-color);}
        .archive-item .profit-value.negative { color: var(--danger-color); text-shadow: 0 0 3px var(--danger-color);}
        .delete-archive-btn {
            position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--icon-color);
            font-size: 1.1em; cursor: pointer; padding: 5px; line-height: 1; border-radius: 50%;
            width: 34px; height: 34px; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, color 0.2s;
        }
        .delete-archive-btn:hover { background-color: rgba(255, 69, 58, 0.2); color: var(--danger-color); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--overlay-color); padding-top: 5%; animation: fadeIn 0.3s ease; }
        .modal-content {
            background-color: var(--bg-dark-secondary);
            color: var(--text-color-light);
            margin: auto; padding: 40px; border: 1px solid var(--border-color-medium);
            width: 90%; max-width: 850px; border-radius: var(--border-radius); position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: var(--bg-dark-tertiary); border-radius: 4px; }
        .modal-body::-webkit-scrollbar-thumb { background-color: var(--text-color-disabled); border-radius: 4px; border: 2px solid var(--bg-dark-tertiary); }
        .close-button {
            color: var(--text-color-medium); position: absolute; top: 20px; right: 30px; font-size: 38px; font-weight: bold; cursor: pointer; line-height: 1; z-index: 10;
        }
        .close-button:hover, .close-button:focus { color: var(--danger-color); text-decoration: none; }
        .modal-content h3 { border-bottom: 1px solid var(--border-color-light); padding-bottom: 18px; text-align: left; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; color: var(--primary-color); }
        .modal-content h4 { margin-top: 28px; margin-bottom: 18px; font-size: 1.25em; color: var(--secondary-color); flex-shrink: 0; display: flex; align-items: center; gap: 8px;}
        #modal-summary p { margin: 12px 0; font-size: 1.1em; display: flex; align-items: flex-start; }
        #modal-summary p strong { font-weight: 600; display: inline-block; min-width: 230px; flex-shrink: 0; color: var(--text-color-medium); }
        #modal-summary .modal-note { font-style: italic; color: var(--text-color-medium); font-size: 0.95em; display: block; margin-left: 0; }
        #modal-summary .profit-value.positive { color: var(--success-color); text-shadow: 0 0 3px var(--success-color);}
        #modal-summary .profit-value.negative { color: var(--danger-color); text-shadow: 0 0 3px var(--danger-color);}
        #modal-details-table-container, #modal-expenses-table-container {
            max-height: 35vh; overflow-y: auto; border: 1px solid var(--border-color-light); border-radius: var(--border-radius); margin-top: 20px;
            background-color: var(--bg-dark-secondary);
        }
        #modal-details-table-container::-webkit-scrollbar, #modal-expenses-table-container::-webkit-scrollbar { width: 6px; }
        #modal-details-table-container::-webkit-scrollbar-track, #modal-expenses-table-container::-webkit-scrollbar-track { background: var(--bg-dark-tertiary); border-radius: 3px; }
        #modal-details-table-container::-webkit-scrollbar-thumb, #modal-expenses-table-container::-webkit-scrollbar-thumb { background-color: var(--text-color-disabled); border-radius: 3px; }
        #modal-details-table, #modal-expenses-table { width: 100%; border-collapse: collapse; }
        #modal-details-table th, #modal-details-table td, #modal-expenses-table th, #modal-expenses-table td {
             border-bottom: 1px solid var(--border-color-light); padding: 12px 15px; text-align: left; color: var(--text-color-light);
        }
        #modal-details-table th, #modal-expenses-table th {
            background-color: var(--bg-dark-tertiary); font-weight: 600; position: sticky; top: 0;
            border-bottom-width: 2px; border-bottom-color: var(--border-color-medium); color: var(--text-color-medium);
            text-transform: uppercase; font-size: 0.85em;
        }
        #modal-details-table td:last-child, #modal-expenses-table td:nth-child(3) { text-align: right; font-weight: 500; color: var(--success-color); }
        #modal-expenses-table td:nth-child(2) { font-size: 0.9em; color: var(--text-color-medium); }
        #modal-details-table tr:last-child td, #modal-expenses-table tr:last-child td { border-bottom: none; }

        .message { font-weight: 600; text-align: center; margin-top: 20px; padding: 12px; border-radius: var(--border-radius); border: 1px solid; }
        .gas-required-message {
            color: var(--danger-color); background-color: rgba(255, 69, 58, 0.1); border-color: rgba(255, 69, 58, 0.3);
        }

        .reset-section { text-align: center; margin-top: 45px; padding-top: 30px; border-top: 1px dashed var(--border-color-light); }
        #reset-app-btn {
            background-color: transparent; color: var(--danger-color); border: 2px solid var(--danger-color);
            width: auto; padding: 12px 20px; font-size: 0.95em; box-shadow: none;
        }
        #reset-app-btn:hover {
            background-color: rgba(255, 69, 58, 0.15); color: var(--danger-hover); border-color: var(--danger-hover);
        }

        [data-tooltip]::before { border-top-color: var(--tooltip-bg); }
        [data-tooltip]::after { background-color: var(--tooltip-bg); color: var(--tooltip-text); font-size: var(--tooltip-font-size); }

        @media (max-width: 992px) {
            .column { min-width: calc(50% - 18px); }
            #archived-list { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
        }
        @media (max-width: 768px) {
             body { padding: 15px; }
             h1 { font-size: 1.9em; } h2 { font-size: 1.4em; margin-bottom: 25px; } h3 { font-size: 1.15em; }
             .main-container { flex-direction: column; gap: 25px; }
             .column { padding: 25px; min-width: unset; width: 100%;}

             .column.ganhos .races-display .summary-value { font-size: 1.8em; } /* Tamanho para corridas no mobile */

             /* >>> MODIFICAÇÃO: Manter lado a lado no mobile <<< */
             .period-summary-inline {
                 /* REMOVIDO: flex-direction: column; */
                 /* Mantém flex-direction: row (padrão) */
                 gap: 15px; /* Espaçamento entre os itens lado a lado */
                 padding: 15px;
             }
             /* >>> FIM DA MODIFICAÇÃO <<< */

             /* Sobrescreve o tamanho geral no mobile */
             .summary-item .summary-value {
                font-size: 1.9em; /* Tamanho geral para valores no mobile */
             }
             /* Aplica a redução específica para Total/Média também no mobile */
             #period-earnings-display,
             #period-average-display {
                 font-size: 1.5em; /* Reduzido de 1.9em (mobile base) */
             }


             #archived-list { grid-template-columns: 1fr; gap: 20px; }
             .archive-item-content { padding: 20px; }
             .modal-content { width: 95%; margin: 5% auto; padding: 25px; }
             .close-button { top: 15px; right: 20px; font-size: 32px; }
             button { padding: 15px 20px; }
             #reset-app-btn { width: 100%; padding: 14px 18px; }
             .input-group-row { flex-direction: column; gap: 15px; }
             [data-tooltip]:not(#add-total-earning-btn)::after { white-space: normal; width: 150px; }
             .label-with-edit { margin-bottom: 8px; }
             h2 { flex-wrap: wrap; justify-content: center; }
             h2 span:first-of-type { flex-basis: 100%; text-align: center; margin-bottom: 8px; }
             h2 #toggle-cycle-content-btn { margin-left: 0; margin-top: 8px; }
         }
        @media (max-width: 400px) {
             /* Ajuste fino para telas muito pequenas */
             #period-earnings-display,
             #period-average-display {
                 font-size: 1.4em; /* Ainda menor para caber */
             }
             .summary-item .summary-label { font-size: 0.8em; }
             .column.ganhos .races-display .summary-value { font-size: 1.6em; }
             /* Garante que mesmo em telas muito pequenas, eles tentem ficar lado a lado */
             .period-summary-inline {
                 gap: 10px; /* Reduz um pouco o espaçamento se necessário */
             }
        }

    </style>
</head>
<body>

    <h1><i class="fa-solid fa-calculator"></i> Ubeleza Calculadora <span class="version">v4.20.5</span></h1>

    <div class="main-container">
        <!-- Coluna de Ganhos (Reorganizada) -->
        <div class="column ganhos">

             <!-- Contagem de Corridas (Movido para o topo) -->
             <div class="races-display">
                 <label>Corridas</label>
                 <span class="summary-value" id="period-race-count-display">0</span>
             </div>

             <!-- Input de Ganhos -->
             <div class="input-wrapper">
                 <label for="earning-total-input">Ganhos Atual R$:</label>
                 <input type="number" id="earning-total-input" placeholder="Ex: 0,00" step="0.01" disabled>
             </div>

             <!-- Linha com Total e Média (Agora sempre em linha) -->
             <div class="period-summary-inline">
                 <div class="summary-item">
                     <span class="summary-label">Total</span>
                     <span class="summary-value" id="period-earnings-display">R$ 0,00</span>
                 </div>
                 <div class="summary-item">
                     <span class="summary-label">Média</span>
                     <span class="summary-value" id="period-average-display">R$ 0,00</span>
                 </div>
             </div>

             <!-- Botão Atualizar Total (Movido para baixo) -->
             <button id="add-total-earning-btn" disabled><i class="fa-solid fa-plus"></i> Atualizar Total (Período)</button>

             <!-- Mensagem de erro e Controles do Histórico -->
             <p id="gas-required-earning" class="message gas-required-message" style="display: none;"><i class="fa-solid fa-triangle-exclamation"></i> Inicie um novo ciclo para adicionar ganhos.</p>

            <div class="history-controls">
                 <h3><i class="fa-solid fa-list-ol"></i> Histórico Corridas (Período Atual)</h3>
                 <div>
                     <button id="toggle-history-btn" class="secondary-toggle-btn" data-tooltip="Mostrar/Ocultar detalhes das corridas"><i class="fa-solid fa-eye-slash"></i> Ocultar</button>
                     <button id="archive-history-btn" data-tooltip="Salva o período atual e zera os ganhos/corridas"><i class="fa-solid fa-floppy-disk"></i> Arquivar Período</button>
                 </div>
            </div>
            <table id="earnings-table" class="hidden">
                <thead><tr><th><i class="fa-solid fa-calendar-alt"></i> Data/Hora</th><th><i class="fa-solid fa-coins"></i> Valor (R$)</th><th><i class="fa-solid fa-wrench"></i> Ações</th></tr></thead>
                <tbody id="earnings-tbody"></tbody>
            </table>
        </div>

        <!-- Coluna de Ciclo Atual -->
        <div class="column gasolina">
            <h2 style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                 <span><i class="fa-solid fa-tachometer-alt"></i> Ciclo Atual</span>
                 <button id="toggle-cycle-content-btn" class="secondary-toggle-btn" data-tooltip="Mostrar/Ocultar detalhes do ciclo">
                     <i class="fa-solid fa-eye-slash"></i> Ocultar
                 </button>
            </h2>

            <div id="cycle-content-wrapper">
                 <div id="cycle-control-buttons" style="margin-bottom: 25px;">
                     <button id="finalize-cycle-btn" class="hidden" data-tooltip="Finaliza o ciclo atual, solicita KM final e arquiva os dados."><i class="fa-solid fa-flag-checkered"></i> Finalizar Ciclo Atual</button>
                     <button id="start-new-cycle-btn" data-tooltip="Inicia um novo ciclo (gasolina, KM inicial, etc.)."><i class="fa-solid fa-gas-pump"></i> Iniciar Novo Ciclo</button>
                 </div>

                 <h3 style="margin-top: 35px;"><i class="fa-solid fa-receipt"></i> Despesas do Ciclo</h3>
                <div class="input-group-row">
                     <div class="input-wrapper" style="min-width: 160px;">
                         <label for="expense-category">Tipo Despesa:</label>
                         <select id="expense-category" disabled>
                             <option value="Água">Água</option> <option value="Refeição">Refeição</option> <option value="Lanche">Lanche</option> <option value="Lavagem">Lavagem</option> <option value="Manutenção">Manutenção</option> <option value="Taxas">Taxas/Estac.</option> <option value="Outros">Outros</option>
                         </select>
                     </div>
                     <div class="input-wrapper">
                         <label for="expense-amount">Valor (R$):</label>
                         <input type="number" id="expense-amount" placeholder="Ex: 5,00" step="0.01" disabled>
                     </div>
                </div>
                <button id="add-expense-btn" data-tooltip="Adiciona esta despesa ao ciclo atual" style="width: auto; padding: 10px 18px; font-size: 1em; margin-bottom: 25px;" disabled><i class="fa-solid fa-cart-plus"></i> Adicionar Despesa</button>

                 <div class="history-controls">
                     <h3><i class="fa-solid fa-list"></i> Histórico Despesas (Ciclo)</h3>
                     <div> <button id="toggle-expense-history-btn" class="secondary-toggle-btn" data-tooltip="Mostrar/Ocultar detalhes das despesas"><i class="fa-solid fa-eye-slash"></i> Ocultar</button> </div>
                 </div>
                 <table id="expenses-table" class="hidden">
                    <thead><tr><th><i class="fa-solid fa-tags"></i> Categoria</th><th><i class="fa-solid fa-clock"></i> Hora</th><th><i class="fa-solid fa-coins"></i> Valor (R$)</th><th><i class="fa-solid fa-wrench"></i> Ação</th></tr></thead>
                    <tbody id="expenses-tbody"></tbody>
                </table>

                <h3 style="margin-top: 35px;"><i class="fa-solid fa-road"></i> Quilometragem (Ciclo Atual)</h3>
                <div class="input-group-row">
                     <div class="input-wrapper">
                         <div class="label-with-edit">
                             <label for="cycle-start-km">KM Inicial:</label>
                             <button id="edit-start-km-btn" class="edit-summary-btn hidden" data-tooltip="Corrigir KM inicial"> <i class="fa-solid fa-pencil"></i> </button>
                         </div>
                         <input type="number" id="cycle-start-km" placeholder="Definir ao iniciar" step="1" disabled title="KM ao iniciar o ciclo">
                     </div>
                     <div class="input-wrapper">
                          <div class="label-with-edit">
                             <label for="cycle-end-km">KM Final:</label>
                             <button id="edit-end-km-btn" class="edit-summary-btn hidden" data-tooltip="Corrigir KM final"> <i class="fa-solid fa-pencil"></i> </button>
                         </div>
                         <input type="number" id="cycle-end-km" placeholder="Definir ao finalizar" step="1" disabled title="KM ao finalizar o ciclo">
                     </div>
                 </div>

                 <h3 style="margin-top: 35px;"><i class="fa-solid fa-clipboard-list"></i> Resumo do Ciclo</h3>
                <div class="summary gasto-registrado">
                    <span> <i class="fa-solid fa-gas-pump"></i><span class="summary-label">GASOLINA:</span> <span id="current-gas-cost" class="summary-value">R$ 0,00</span>
                        <button id="edit-current-gas-btn" class="edit-summary-btn hidden" data-tooltip="Corrigir gasolina"> <i class="fa-solid fa-pencil"></i> </button>
                    </span>
                </div>
                <div class="summary outras-despesas">
                    <span><i class="fa-solid fa-receipt"></i><span class="summary-label">OUTRAS DESPESAS:</span> <span id="cycle-other-expenses" class="summary-value">R$ 0,00</span></span>
                </div>
                 <div class="summary lucro">
                     <span><i class="fa-solid fa-sack-dollar"></i><span class="summary-label">LUCRO LÍQUIDO:</span> <span id="profit" class="summary-value">R$ 0,00</span></span>
                 </div>
                 <div class="summary corridas">
                    <span><i class="fa-solid fa-route"></i><span class="summary-label">CORRIDAS (Ciclo):</span> <span id="race-count" class="summary-value">0</span></span>
                 </div>
                 <div class="summary km-rodados">
                    <span><i class="fa-solid fa-road"></i><span class="summary-label">KM RODADOS:</span> <span id="cycle-km-driven" class="summary-value">0 KM</span></span>
                 </div>
                  <div class="summary calculos-extra">
                      <span> <i class="fa-solid fa-tag"></i><span class="summary-label">PREÇO/L:</span> <span id="cycle-fuel-price" class="summary-value na">N/A</span>
                          <button id="edit-fuel-price-btn" class="edit-summary-btn hidden" data-tooltip="Editar preço/litro"> <i class="fa-solid fa-pencil"></i> </button>
                      </span>
                  </div>
                  <div class="summary calculos-extra">
                     <span><i class="fa-solid fa-ruler-combined"></i><span class="summary-label">KM/L:</span> <span id="cycle-km-per-liter" class="summary-value na">N/A</span></span>
                  </div>
                  <div class="summary calculos-extra">
                     <span><i class="fa-solid fa-coins"></i><span class="summary-label">CUSTO/KM:</span> <span id="cycle-cost-per-km" class="summary-value na">N/A</span></span>
                  </div>

                 <div id="cost-simulator">
                    <h3><i class="fa-solid fa-calculator"></i> Simulador de Custo por KM</h3>
                    <div class="input-group-row">
                        <div class="input-wrapper">
                            <label for="simulation-km">Distância (KM):</label>
                            <input type="number" id="simulation-km" placeholder="Ex: 100" step="1">
                        </div>
                        <div class="input-wrapper" style="align-self: flex-end;">
                             <button id="simulate-cost-btn" data-tooltip="Calcula custo com base no Custo/KM (último ciclo ou atual)" disabled><i class="fa-solid fa-play"></i> Calcular Custo</button>
                        </div>
                    </div>
                     <p id="simulation-result"> </p>
                 </div>

                 <div id="chart-container">
                     <canvas id="profitChart"></canvas>
                 </div>
            </div>
        </div>
    </div>

    <!-- Seção Arquivada -->
    <div class="archived-section">
        <h2><i class="fa-solid fa-book"></i> Histórico Arquivado</h2>
        <div id="archived-chart-container" style="display: none;"> <canvas id="archivedStatsChart"></canvas> </div>
        <div id="archived-list"> <p id="no-archives-message" style="display: none;">Nenhum período arquivado ainda.</p> </div>
    </div>

     <!-- Botão Reset -->
     <div class="reset-section"> <button id="reset-app-btn" data-tooltip="Apaga TODOS os dados salvos!"><i class="fa-solid fa-bomb"></i> Zerar Todos os Dados</button> </div>

    <!-- Modal -->
    <div id="archive-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="modal-close-btn" data-tooltip="Fechar">×</span>
            <div id="modal-export-content">
                <h3 id="modal-title-container">
                    <span id="modal-title">Detalhes do Arquivo</span>
                </h3>
                <div class="modal-body">
                    <div id="modal-summary"></div>
                    <h4 id="modal-runs-title" style="display: none;"><i class="fa-solid fa-list-ol"></i> Histórico de Corridas:</h4>
                    <div id="modal-details-table-container" style="display: none;">
                        <table id="modal-details-table">
                            <thead><tr><th>Data/Hora</th><th>Valor (R$)</th></tr></thead>
                            <tbody id="modal-tbody"></tbody>
                        </table>
                    </div>
                     <h4 id="modal-expenses-title" style="display: none;"><i class="fa-solid fa-receipt"></i> Histórico de Despesas:</h4>
                     <div id="modal-expenses-table-container" style="display: none;">
                         <table id="modal-expenses-table">
                            <thead><tr><th>Categoria</th><th>Data/Hora</th><th>Valor (R$)</th></tr></thead>
                            <tbody id="modal-expenses-tbody"></tbody>
                         </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos DOM ---
            const earningTotalInput = document.getElementById('earning-total-input');
            const addTotalEarningBtn = document.getElementById('add-total-earning-btn');
            const periodEarningsDisplaySpan = document.getElementById('period-earnings-display');
            const periodRaceCountDisplaySpan = document.getElementById('period-race-count-display');
            const periodAverageDisplaySpan = document.getElementById('period-average-display');
            const earningsTbody = document.getElementById('earnings-tbody');
            const toggleHistoryBtn = document.getElementById('toggle-history-btn');
            const archiveHistoryBtn = document.getElementById('archive-history-btn');
            const earningsTable = document.getElementById('earnings-table');
            const gasRequiredEarningMsg = document.getElementById('gas-required-earning');
            const startNewCycleBtn = document.getElementById('start-new-cycle-btn');
            const finalizeCycleBtn = document.getElementById('finalize-cycle-btn');
            const currentGasCostSpan = document.getElementById('current-gas-cost');
            const editCurrentGasBtn = document.getElementById('edit-current-gas-btn');
            const expenseCategorySelect = document.getElementById('expense-category');
            const expenseAmountInput = document.getElementById('expense-amount');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const expensesTable = document.getElementById('expenses-table');
            const expensesTbody = document.getElementById('expenses-tbody');
            const toggleExpenseHistoryBtn = document.getElementById('toggle-expense-history-btn');
            const startKmInput = document.getElementById('cycle-start-km');
            const endKmInput = document.getElementById('cycle-end-km');
            const cycleOtherExpensesSpan = document.getElementById('cycle-other-expenses');
            const profitSpan = document.getElementById('profit');
            const lucroDiv = document.querySelector('.lucro');
            const raceCountSpan = document.getElementById('race-count');
            const cycleKmDrivenSpan = document.getElementById('cycle-km-driven');
            const cycleFuelPriceSpan = document.getElementById('cycle-fuel-price');
            const editFuelPriceBtn = document.getElementById('edit-fuel-price-btn');
            const cycleKmPerLiterSpan = document.getElementById('cycle-km-per-liter');
            const cycleCostPerKmSpan = document.getElementById('cycle-cost-per-km');
            const simulationKmInput = document.getElementById('simulation-km');
            const simulateCostBtn = document.getElementById('simulate-cost-btn');
            const simulationResultP = document.getElementById('simulation-result');
            const archivedListDiv = document.getElementById('archived-list');
            const noArchivesMessage = document.getElementById('no-archives-message');
            const archivedChartContainer = document.getElementById('archived-chart-container');
            const modal = document.getElementById('archive-details-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalTitleSpan = document.getElementById('modal-title');
            const modalSummaryDiv = document.getElementById('modal-summary');
            const modalTbody = document.getElementById('modal-tbody');
            const modalExpensesTbody = document.getElementById('modal-expenses-tbody');
            const modalRunsTitle = document.getElementById('modal-runs-title');
            const modalExpensesTitle = document.getElementById('modal-expenses-title');
            const modalDetailsTableContainer = document.getElementById('modal-details-table-container');
            const modalExpensesTableContainer = document.getElementById('modal-expenses-table-container');
            const resetAppBtn = document.getElementById('reset-app-btn');
            const editStartKmBtn = document.getElementById('edit-start-km-btn');
            const editEndKmBtn = document.getElementById('edit-end-km-btn');
            const toggleCycleContentBtn = document.getElementById('toggle-cycle-content-btn');
            const cycleContentWrapper = document.getElementById('cycle-content-wrapper');

            // *** CORREÇÃO: Mover para DENTRO do DOMContentLoaded ***
            const profitChartCtx = document.getElementById('profitChart')?.getContext('2d'); // Adicionado '?' para segurança
            const archivedChartCtx = document.getElementById('archivedStatsChart')?.getContext('2d'); // Adicionado '?' para segurança

            // --- Configurações e Estado ---
            const API_BASE_URL = 'http://127.0.0.1:5000/api'; // URL do seu backend Flask
            const storagePrefix = 'v4.20.5_ui_'; // Prefixo para estado da UI no localStorage

            // Estado do aplicativo (será preenchido pela API)
            let appState = {
                currentCycle: null,
                earningsList: [],
                expenseList: [],
                archives: []
            };

            // Estado da UI (mantido no localStorage)
            let isHistoryVisible = localStorage.getItem(storagePrefix + 'isHistoryVisible') === 'true';
            let isExpenseHistoryVisible = localStorage.getItem(storagePrefix + 'isExpenseHistoryVisible') === 'true';
            let isCycleContentVisible = localStorage.getItem(storagePrefix + 'isCycleContentVisible') !== 'false';

            // Variáveis auxiliares (mantidas)
            let profitChartInstance = null;
            let archivedStatsChartInstance = null;
            let currentArchiveIndex = -1; // Para saber qual arquivo está no modal
            let currentCostPerKmValue = null; // Recalculado no frontend

            const MIN_INCREMENT = 5.00;
            const MAX_INCREMENT = 60.00;
            const NA_DISPLAY = "N/A";
            const DARK_COLORS = { /* ... (cores mantidas) ... */
                gas: 'rgba(255, 69, 58, 0.7)',
                others: 'rgba(94, 92, 230, 0.7)',
                profit: 'rgba(48, 209, 88, 0.7)',
                insufficient: 'rgba(255, 159, 10, 0.7)',
                noData: 'rgba(142, 142, 147, 0.7)',
                border: '#1c1c1e'
            };

            // --- Funções de Formatação (mantidas) ---
            function formatCurrency(value) { if (typeof value !== 'number' || isNaN(value)) return 'R$ 0,00'; return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
            function formatNumber(value, decimals = 2) { if (typeof value !== 'number' || isNaN(value)) return 'N/A'; return value.toLocaleString('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
            function formatDateTime(dateObjOrStr, includeTime = true) { try { const date = dateObjOrStr instanceof Date ? dateObjOrStr : new Date(dateObjOrStr); if (isNaN(date.getTime())) return dateObjOrStr; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = String(date.getFullYear()).slice(-2); if (!includeTime) return `${day}/${month}/${year}`; const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${day}/${month}/${year} ${hours}:${minutes}`; } catch (e) { console.error("Erro formatando data:", dateObjOrStr, e); return dateObjOrStr; } }
            function parseArchivedValue(value) { return typeof value === 'number' && !isNaN(value) ? value : 0; } // Usado no modal/lista de arquivos
            function parseCurrencyString(valueStr) { if (!valueStr || typeof valueStr !== 'string' || valueStr.toUpperCase() === NA_DISPLAY) { return null; } try { const cleanedStr = String(valueStr).replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.'); const value = parseFloat(cleanedStr); return isNaN(value) ? null : value; } catch (e) { console.error("Erro ao parsear string de moeda:", valueStr, e); return null; } } // Usado no simulador

            // --- Funções de Cálculo (mantidas no frontend para UI) ---
            function calculateKmDriven(start, end) { const startKm = parseInt(start, 10); const endKm = parseInt(end, 10); if (!isNaN(startKm) && !isNaN(endKm) && startKm >= 0 && endKm > 0 && endKm >= startKm) { return endKm - startKm; } return 0; }
            function calculateKmPerLiter(kmDriven, gasCost, fuelPrice) { if (kmDriven > 0 && gasCost > 0 && fuelPrice > 0) { const litersUsed = gasCost / fuelPrice; if (litersUsed > 0) { return (kmDriven / litersUsed); } } return null; }
            function calculateCostPerKmValue(gasCost, totalOtherExpenses, kmDriven) { if (kmDriven > 0) { const totalCost = gasCost + totalOtherExpenses; return totalCost / kmDriven; } return null; }
            function getTotalOtherExpenses() { return appState.expenseList.reduce((sum, expense) => sum + expense.amount, 0); }

            // --- Função Auxiliar para API ---
            async function fetchApi(endpoint, method = 'GET', body = null) {
                const url = `${API_BASE_URL}${endpoint}`;
                const options = {
                    method: method,
                    headers: {}
                };
                if (body) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(body);
                }

                try {
                    // console.log(`API Request: ${method} ${url}`, body ? body : ''); // Log para debug
                    const response = await fetch(url, options);
                    const responseData = await response.json(); // Tenta parsear JSON mesmo em erro
                    // console.log(`API Response: ${response.status}`, responseData); // Log para debug

                    if (!response.ok) {
                        // Tenta exibir a mensagem de erro do backend, senão uma genérica
                        const errorMessage = responseData?.error || `Erro ${response.status}: ${response.statusText}`;
                        console.error("API Error:", errorMessage);
                        alert(`Erro na comunicação com o servidor:\n${errorMessage}`);
                        return null; // Indica falha
                    }
                    return responseData; // Retorna os dados em caso de sucesso
                } catch (error) {
                    console.error(`Falha na requisição para ${method} ${url}:`, error);
                    alert("Erro de rede ou falha ao conectar com o servidor. Verifique o console para detalhes.");
                    return null; // Indica falha grave
                }
            }

            // --- Funções de Atualização da UI (Modificadas para usar appState) ---
            function updateUIFromState() {
                // Atualiza todas as partes da UI com base no appState atual
                updateSummaryAndCounts();
                updateEarningsTable();
                updateExpenseTable();
                loadArchivedList(); // Renderiza a lista de arquivos do appState
                updateProfitChart();
                updateArchivedStatsChart(); // Atualiza gráfico de arquivos
                checkCycleStateAndToggleUI(); // Habilita/desabilita botões e inputs
                updateSimulatorState(); // Habilita/desabilita simulador
            }

            function updateSummaryAndCounts() {
                const cycle = appState.currentCycle;
                const earningsList = appState.earningsList;
                const expenseList = appState.expenseList;

                const gasCost = cycle?.gas_cost || 0;
                const cumulativeEarnings = cycle?.cumulative_earnings || 0;
                const cumulativeRaces = cycle?.cumulative_race_count || 0;
                const periodEarnings = cycle?.current_period_earnings || 0;
                const periodRaces = cycle?.current_period_race_count || 0;
                const startKM = cycle?.start_km || 0;
                const endKM = cycle?.end_km || 0;
                const fuelPrice = cycle?.fuel_price_per_liter || 0;

                const totalOtherExpenses = getTotalOtherExpenses(); // Usa a função que soma appState.expenseList
                const profit = cumulativeEarnings - gasCost - totalOtherExpenses;
                const kmDriven = calculateKmDriven(startKM, endKM);
                const kmPerLiterValue = calculateKmPerLiter(kmDriven, gasCost, fuelPrice);
                currentCostPerKmValue = calculateCostPerKmValue(gasCost, totalOtherExpenses, kmDriven); // Atualiza variável global para simulador
                const periodAverage = periodRaces > 0 ? periodEarnings / periodRaces : 0;

                // Atualiza displays do período
                periodEarningsDisplaySpan.textContent = formatCurrency(periodEarnings);
                periodRaceCountDisplaySpan.textContent = periodRaces;
                periodAverageDisplaySpan.textContent = formatCurrency(periodAverage);

                // Atualiza resumo do ciclo
                currentGasCostSpan.textContent = formatCurrency(gasCost);
                cycleOtherExpensesSpan.textContent = formatCurrency(totalOtherExpenses);
                profitSpan.textContent = formatCurrency(profit);
                lucroDiv.classList.toggle('positivo', profit >= 0);
                lucroDiv.classList.toggle('negativo', profit < 0);
                raceCountSpan.textContent = cumulativeRaces; // Corridas totais do ciclo
                cycleKmDrivenSpan.textContent = `${kmDriven} KM`;
                cycleFuelPriceSpan.textContent = fuelPrice > 0 ? formatCurrency(fuelPrice) : NA_DISPLAY;
                cycleFuelPriceSpan.classList.toggle('na', !(fuelPrice > 0));

                if (kmPerLiterValue !== null) {
                    cycleKmPerLiterSpan.innerHTML = `${formatNumber(kmPerLiterValue)} Km/L`;
                    cycleKmPerLiterSpan.classList.remove('na');
                } else {
                    cycleKmPerLiterSpan.textContent = NA_DISPLAY;
                    cycleKmPerLiterSpan.classList.add('na');
                }

                const costPerKmFormatted = currentCostPerKmValue !== null ? formatCurrency(currentCostPerKmValue) : NA_DISPLAY;
                cycleCostPerKmSpan.textContent = costPerKmFormatted + (currentCostPerKmValue !== null ? '/KM' : '');
                cycleCostPerKmSpan.classList.toggle('na', currentCostPerKmValue === null);

                startKmInput.value = startKM > 0 ? startKM : '';
                endKmInput.value = endKM > 0 ? endKM : '';

                // Habilita/desabilita botão Arquivar Período
                archiveHistoryBtn.disabled = !(periodEarnings > 0 || periodRaces > 0);
            }

            function updateEarningsTable() {
                earningsTbody.innerHTML = '';
                // Ordena por timestamp DESC para mostrar mais recente primeiro
                [...appState.earningsList].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach((earning) => {
                    const row = earningsTbody.insertRow();
                    row.insertCell().textContent = formatDateTime(earning.timestamp);
                    const valueCell = row.insertCell();
                    valueCell.textContent = formatCurrency(earning.amount);
                    valueCell.style.textAlign = 'right';
                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('actions-cell');

                    const editBtn = document.createElement('button');
                    editBtn.classList.add('action-btn', 'edit-btn');
                    editBtn.innerHTML = '<i class="fa-solid fa-pencil"></i>';
                    editBtn.setAttribute('data-tooltip', 'Editar valor');
                    editBtn.dataset.id = earning.id; // Usa o ID do banco
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('action-btn', 'delete-btn');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    deleteBtn.setAttribute('data-tooltip', 'Excluir corrida');
                    deleteBtn.dataset.id = earning.id; // Usa o ID do banco
                    actionsCell.appendChild(deleteBtn);
                });
                toggleHistoryTable(isHistoryVisible, false); // Atualiza visibilidade sem salvar no localStorage
            }

            function updateExpenseTable() {
                expensesTbody.innerHTML = '';
                [...appState.expenseList].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach((expense) => {
                    const row = expensesTbody.insertRow();
                    row.insertCell().textContent = expense.category;
                    row.insertCell().textContent = formatDateTime(expense.timestamp, true); // Inclui hora
                    const valueCell = row.insertCell();
                    valueCell.textContent = formatCurrency(expense.amount);
                    valueCell.style.textAlign = 'right';
                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('actions-cell');

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('action-btn', 'delete-btn');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    deleteBtn.setAttribute('data-tooltip', 'Excluir despesa');
                    deleteBtn.dataset.id = expense.id; // Usa o ID do banco
                    actionsCell.appendChild(deleteBtn);
                });
                toggleExpenseHistoryTable(isExpenseHistoryVisible, false); // Atualiza visibilidade sem salvar no localStorage
            }

            function loadArchivedList() {
                archivedListDiv.innerHTML = '';
                noArchivesMessage.style.display = appState.archives.length === 0 ? 'block' : 'none';
                // Ordena pela data do arquivamento (já vem ordenado da API, mas seguro re-ordenar)
                 [...appState.archives].sort((a, b) => new Date(b.archiveDate) - new Date(a.archiveDate)).forEach((archive) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('archive-item');

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-archive-btn');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
                    deleteBtn.setAttribute('data-tooltip', 'Excluir arquivo');
                    deleteBtn.dataset.id = archive.db_id; // Usa o ID do banco
                    itemDiv.appendChild(deleteBtn);

                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('archive-item-content');
                    contentDiv.dataset.id = archive.db_id; // Usa o ID do banco para buscar detalhes
                    contentDiv.setAttribute('data-tooltip', 'Ver detalhes');
                    contentDiv.style.cursor = 'pointer';

                    const isFullCycle = archive.archiveType === "Ciclo Completo";
                    const archiveDate = formatDateTime(archive.archiveDate);
                    const endDate = formatDateTime(archive.periodEndDate || archive.archiveDate);
                    const earnings = parseArchivedValue(isFullCycle ? archive.cycleEarnings : archive.periodEarnings);
                    const races = parseArchivedValue(isFullCycle ? archive.cycleRaceCount : archive.periodRaceCount);
                    const gas = parseArchivedValue(isFullCycle ? archive.gasCost : archive.gasCostSnapshot);
                    const profit = parseArchivedValue(isFullCycle ? archive.summary_profit : archive.cycleProfitSnapshot);
                    const note = archive.note || '';
                    const profitClass = profit >= 0 ? 'positive' : 'negative';

                    let contentHTML = `<p><strong><i class="fa-solid ${isFullCycle ? 'fa-calendar-check' : 'fa-calendar-day'}"></i> ${archive.archiveType}:</strong> ${archiveDate}</p>`;
                    contentHTML += `<p><i class="fa-regular fa-clock"></i><strong>Fim:</strong> ${endDate}</p>`;
                    contentHTML += `<p><i class="fa-solid fa-sack-dollar"></i><strong>Ganhos:</strong> ${formatCurrency(earnings)}</p>`;
                    contentHTML += `<p><i class="fa-solid fa-route"></i><strong>Corridas:</strong> ${races}</p>`;
                    contentHTML += `<p><i class="fa-solid fa-gas-pump"></i><strong>Gasolina:</strong> ${formatCurrency(gas)}</p>`;

                    if (isFullCycle) {
                        const otherExpenses = parseArchivedValue(archive.summary_totalOtherExpenses);
                        const kmDriven = parseArchivedValue(archive.summary_kmDriven);
                        const kmPerLiter = archive.summary_kmPerLiter || NA_DISPLAY;
                        const costPerKm = archive.summary_costPerKm || NA_DISPLAY; // Já vem formatado do backend
                        const startKm = parseArchivedValue(archive.startKM);
                        const endKm = parseArchivedValue(archive.endKM);
                        if (otherExpenses > 0) contentHTML += `<p><i class="fa-solid fa-receipt"></i><strong>Outras Desp.:</strong> ${formatCurrency(otherExpenses)}</p>`;
                        if (kmDriven > 0) {
                            contentHTML += `<p><i class="fa-solid fa-road"></i><strong>KM Rodados:</strong> ${kmDriven} KM (${startKm} - ${endKm})</p>`;
                            if (kmPerLiter !== NA_DISPLAY) contentHTML += `<p><i class="fa-solid fa-ruler-combined"></i><strong>KM/L:</strong> ${kmPerLiter}</p>`; // Já formatado
                            if (costPerKm !== NA_DISPLAY) contentHTML += `<p><i class="fa-solid fa-coins"></i><strong>Custo/KM:</strong> R$ ${costPerKm}</p>`; // Já formatado (adiciona R$)
                        }
                    }
                    contentHTML += `<p><i class="fa-solid fa-chart-pie"></i><strong>Lucro ${isFullCycle ? 'Líquido' : '(Snap.)'}:</strong> <span class="profit-value ${profitClass}">${formatCurrency(profit)}</span></p>`;
                    if (note) {
                        contentHTML += `<p><i class="fa-solid fa-note-sticky"></i><strong>Nota:</strong><span class="archive-note">${note}</span></p>`;
                    }
                    contentDiv.innerHTML = contentHTML;
                    itemDiv.appendChild(contentDiv);
                    archivedListDiv.appendChild(itemDiv);
                });
                updateSimulatorState(); // Atualiza estado do simulador baseado nos arquivos
            }

            function checkCycleStateAndToggleUI() {
                const isCycleActive = appState.currentCycle?.is_active || false;

                startNewCycleBtn.classList.toggle('hidden', isCycleActive);
                finalizeCycleBtn.classList.toggle('hidden', !isCycleActive);

                earningTotalInput.disabled = !isCycleActive;
                addTotalEarningBtn.disabled = !isCycleActive || earningTotalInput.value.trim() === '';
                gasRequiredEarningMsg.style.display = isCycleActive ? 'none' : 'block';

                editCurrentGasBtn.classList.toggle('hidden', !isCycleActive);
                editFuelPriceBtn.classList.toggle('hidden', !isCycleActive);
                editStartKmBtn.classList.toggle('hidden', !isCycleActive);
                editEndKmBtn.classList.toggle('hidden', !isCycleActive); // Habilita edição de KM final se ciclo ativo

                expenseCategorySelect.disabled = !isCycleActive;
                expenseAmountInput.disabled = !isCycleActive;
                addExpenseBtn.disabled = !isCycleActive || expenseAmountInput.value.trim() === '';

                startKmInput.disabled = true; // Sempre desabilitado para visualização
                endKmInput.disabled = true;   // Sempre desabilitado para visualização

                // Habilitar botão de arquivar período apenas se houver dados no período
                archiveHistoryBtn.disabled = !(appState.currentCycle?.current_period_earnings > 0 || appState.currentCycle?.current_period_race_count > 0);

            }

            // --- Funções de Controle da UI (Visibilidade - Mantidas com localStorage) ---
            function toggleHistoryTable(show, shouldSave = true) {
                earningsTable.classList.toggle('hidden', !show);
                toggleHistoryBtn.innerHTML = show ? '<i class="fa-solid fa-eye-slash"></i> Ocultar' : '<i class="fa-solid fa-eye"></i> Mostrar';
                isHistoryVisible = show;
                if (shouldSave) {
                    localStorage.setItem(storagePrefix + 'isHistoryVisible', isHistoryVisible.toString());
                }
            }
            function toggleExpenseHistoryTable(show, shouldSave = true) {
                expensesTable.classList.toggle('hidden', !show);
                toggleExpenseHistoryBtn.innerHTML = show ? '<i class="fa-solid fa-eye-slash"></i> Ocultar' : '<i class="fa-solid fa-eye"></i> Mostrar';
                isExpenseHistoryVisible = show;
                if (shouldSave) {
                    localStorage.setItem(storagePrefix + 'isExpenseHistoryVisible', isExpenseHistoryVisible.toString());
                }
            }
             function toggleCycleContent(show, shouldSave = true) {
                cycleContentWrapper.classList.toggle('hidden', !show);
                toggleCycleContentBtn.innerHTML = show ? '<i class="fa-solid fa-eye-slash"></i> Ocultar' : '<i class="fa-solid fa-eye"></i> Mostrar';
                isCycleContentVisible = show;
                if (shouldSave) {
                    localStorage.setItem(storagePrefix + 'isCycleContentVisible', isCycleContentVisible.toString());
                }
            }

            // --- Funções de Gráficos (Modificadas para usar appState) ---
            function initializeProfitChart() {
                if (profitChartInstance) profitChartInstance.destroy();
                // *** Adicionado try-catch para segurança extra ***
                try {
                    if (!profitChartCtx) {
                         console.error("Contexto do gráfico de lucro não encontrado ao inicializar.");
                         return;
                     }
                    profitChartInstance = new Chart(profitChartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{ data: [], backgroundColor: [], borderColor: [DARK_COLORS.border], borderWidth: 3 }] },
                        options: {
                            responsive: true, maintainAspectRatio: false, cutout: '65%',
                            plugins: {
                                legend: { position: 'bottom', labels: { color: '#a0a0a5', boxWidth: 15, padding: 15 } },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#eee', bodyColor: '#eee',
                                    callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } },
                                title: { display: true, text: 'Ganhos vs. Despesas (Ciclo Atual)', font: { size: 15 }, color: '#f2f2f7', padding: { top: 10, bottom: 20 } }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Erro ao inicializar gráfico de lucro:", e);
                }
             }
            function updateProfitChart() {
                // Adicionado verificação se a instância existe
                if (!profitChartInstance || !appState.currentCycle) return;

                const gas = appState.currentCycle?.gas_cost || 0;
                const cycleEarn = appState.currentCycle?.cumulative_earnings || 0;
                const totalOtherExpenses = getTotalOtherExpenses(); // Usa appState.expenseList
                const totalExpenses = gas + totalOtherExpenses;
                const profit = cycleEarn - totalExpenses;

                let labels, data, bgColors;
                const gasVal = Math.max(0, gas);
                const othersVal = Math.max(0, totalOtherExpenses);
                const earnVal = Math.max(0, cycleEarn);
                const profitVal = Math.max(0, profit);

                if (earnVal <= 0 && totalExpenses <= 0) { labels = ['Sem Dados no Ciclo']; data = [1]; bgColors = [DARK_COLORS.noData]; }
                else if (earnVal <= 0 && totalExpenses > 0) { labels = ['Gasto Gasolina', 'Outras Despesas']; data = [gasVal, othersVal]; bgColors = [DARK_COLORS.gas, DARK_COLORS.others]; }
                else if (profit <= 0) { labels = ['Gasto Gasolina', 'Outras Despesas', 'Ganhos (Insuf.)']; data = [gasVal, othersVal, earnVal]; bgColors = [DARK_COLORS.gas, DARK_COLORS.others, DARK_COLORS.insufficient]; }
                 else { labels = ['Gasto Gasolina', 'Outras Despesas', 'Lucro Líquido']; data = [gasVal, othersVal, profitVal]; bgColors = [DARK_COLORS.gas, DARK_COLORS.others, DARK_COLORS.profit]; }

                const filteredData = []; const filteredLabels = []; const filteredBgColors = [];
                data.forEach((value, index) => { if (value > 0 || (labels.length === 1 && labels[0] === 'Sem Dados no Ciclo') ) { filteredData.push(value); filteredLabels.push(labels[index]); filteredBgColors.push(bgColors[index]); } });

                profitChartInstance.data.labels = filteredLabels;
                profitChartInstance.data.datasets[0].data = filteredData;
                profitChartInstance.data.datasets[0].backgroundColor = filteredBgColors;
                profitChartInstance.update();
            }
            function initializeArchivedStatsChart() {
                if (archivedStatsChartInstance) archivedStatsChartInstance.destroy();
                 // *** Adicionado try-catch para segurança extra ***
                 try {
                    if (!archivedChartCtx) {
                         console.error("Contexto do gráfico de arquivados não encontrado ao inicializar.");
                         return;
                     }
                    archivedStatsChartInstance = new Chart(archivedChartCtx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [
                                { label: 'Ganhos (R$)', data: [], backgroundColor: 'rgba(48, 209, 88, 0.6)', borderColor: 'rgba(48, 209, 88, 1)', borderWidth: 1, yAxisID: 'y-axis-earnings' },
                                { label: 'Nº Corridas', data: [], backgroundColor: 'rgba(10, 132, 255, 0.6)', borderColor: 'rgba(10, 132, 255, 1)', borderWidth: 1, yAxisID: 'y-axis-races' }
                            ]
                        },
                        options: { /* ... (opções mantidas) ... */
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top', labels: { color: '#a0a0a5' } },
                                title: { display: true, text: 'Estatísticas dos Períodos Arquivados', font: { size: 16 }, color: '#f2f2f7', padding: { bottom: 20 } },
                                tooltip: {
                                     backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#eee', bodyColor: '#eee',
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || ''; if (label) { label += ': '; }
                                            if (context.dataset.yAxisID === 'y-axis-earnings') { label += formatCurrency(context.parsed.y); } else { label += context.parsed.y; }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { title: { display: true, text: 'Período Arquivado (Data Fim)', color: '#a0a0a5' }, ticks: { color: '#a0a0a5' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                                'y-axis-earnings': { type: 'linear', position: 'left', title: { display: true, text: 'Valor (R$)', color: '#a0a0a5' }, ticks: { callback: (value) => formatCurrency(value), color: '#a0a0a5' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                                'y-axis-races': { type: 'linear', position: 'right', title: { display: true, text: 'Nº Corridas', color: '#a0a0a5' }, grid: { drawOnChartArea: false }, ticks: { stepSize: 1, precision: 0, color: '#a0a0a5' } }
                            }
                       }
                    });
                } catch(e) {
                     console.error("Erro ao inicializar gráfico de arquivados:", e);
                 }
            }
            function updateArchivedStatsChart() {
                 // Adicionado verificação se a instância existe
                if (!archivedStatsChartInstance || !archivedChartContainer) return;
                // Usa appState.archives
                const sortedArchives = [...appState.archives].sort((a, b) => new Date(a.archiveDate) - new Date(b.archiveDate)); // Ordena ASC para o gráfico
                const labels = []; const earningsData = []; const racesData = [];

                sortedArchives.forEach(archive => {
                    const isFullCycle = archive.archiveType === "Ciclo Completo";
                    const earnings = parseArchivedValue(isFullCycle ? archive.cycleEarnings : archive.periodEarnings);
                    const races = parseArchivedValue(isFullCycle ? archive.cycleRaceCount : archive.periodRaceCount);
                    const labelDate = formatDateTime(archive.periodEndDate || archive.archiveDate, false) || 'N/D';
                    labels.push(labelDate);
                    earningsData.push(earnings);
                    racesData.push(races);
                });

                archivedStatsChartInstance.data.labels = labels;
                archivedStatsChartInstance.data.datasets[0].data = earningsData;
                archivedStatsChartInstance.data.datasets[1].data = racesData;
                archivedStatsChartInstance.update();
                archivedChartContainer.style.display = appState.archives.length > 0 ? 'block' : 'none';
            }

            // --- Funções de Ação (Modificadas para usar API) ---

            async function addOrUpdateTotalEarning() {
                const currentPeriodEarnings = appState.currentCycle?.current_period_earnings || 0;
                const newTotalText = earningTotalInput.value.replace(',', '.');
                const newPeriodTotalAmount = parseFloat(newTotalText);

                if (isNaN(newPeriodTotalAmount) || newPeriodTotalAmount < 0) {
                    alert('Valor total de ganhos inválido.');
                    earningTotalInput.focus();
                    return;
                }

                let difference = 0;
                let isCorrection = false; // Flag para indicar se é apenas uma correção de total

                if (currentPeriodEarnings > 0) {
                    difference = newPeriodTotalAmount - currentPeriodEarnings;
                }

                if (newPeriodTotalAmount < currentPeriodEarnings) {
                    if (!confirm(`ATENÇÃO: O novo total (${formatCurrency(newPeriodTotalAmount)}) é MENOR que o anterior (${formatCurrency(currentPeriodEarnings)}).\n\nIsso irá CORRIGIR o total do período, mas NÃO contará como uma nova corrida.\n\nDeseja continuar?`)) {
                        earningTotalInput.select();
                        return;
                    }
                    isCorrection = true; // É uma correção, envia diferença negativa
                } else if (newPeriodTotalAmount === currentPeriodEarnings) {
                    alert(`O valor inserido (${formatCurrency(newPeriodTotalAmount)}) é igual ao total atual. Nenhuma alteração feita.`);
                    earningTotalInput.value = '';
                    earningTotalInput.focus();
                    return;
                } else if (currentPeriodEarnings > 0 && difference > 0) { // Adicionando a um período existente
                    if (difference > MAX_INCREMENT) {
                        if (!confirm(`ATENÇÃO: Aumento de ${formatCurrency(difference)} (maior que ${formatCurrency(MAX_INCREMENT)}).\nConfirmar como 1 corrida?`)) {
                            earningTotalInput.select(); return;
                        }
                    } else if (difference < MIN_INCREMENT) {
                        if (!confirm(`AVISO: Aumento de ${formatCurrency(difference)} (menor que ${formatCurrency(MIN_INCREMENT)}).\nConfirmar como 1 corrida?`)) {
                            earningTotalInput.select(); return;
                        }
                    }
                    // difference já está calculado
                } else if (currentPeriodEarnings <= 0 && newPeriodTotalAmount > 0) { // Iniciando o período com um total
                    if (!confirm(`Registrar ${formatCurrency(newPeriodTotalAmount)} como total inicial e 1 corrida?`)) {
                        earningTotalInput.select();
                        return;
                    }
                    difference = newPeriodTotalAmount; // O primeiro valor é a diferença
                }

                // Envia para a API
                const payload = {
                    amount: difference, // Envia a diferença calculada
                    timestamp: new Date().toISOString(),
                    new_period_total: newPeriodTotalAmount // Envia o novo total final esperado
                };
                const result = await fetchApi('/earnings', 'POST', payload);

                if (result) {
                    appState = result; // Atualiza TODO o estado com a resposta da API
                    updateUIFromState();
                    earningTotalInput.value = '';
                    earningTotalInput.focus();
                }
                // Erro já foi tratado em fetchApi
            }

            async function addExpense() {
                const category = expenseCategorySelect.value;
                const amountText = expenseAmountInput.value.replace(',', '.');
                const amount = parseFloat(amountText);

                if (!category) { alert('Selecione uma categoria.'); expenseCategorySelect.focus(); return; }
                if (isNaN(amount) || amount <= 0) { alert('Valor da despesa inválido.'); expenseAmountInput.focus(); return; }

                const payload = {
                    category: category,
                    amount: amount,
                    timestamp: new Date().toISOString()
                };
                const result = await fetchApi('/expenses', 'POST', payload);

                if (result) {
                    appState = result; // API retorna o estado atualizado
                    updateUIFromState();
                    expenseAmountInput.value = '';
                    expenseCategorySelect.value = 'Água'; // Reseta select
                    expenseCategorySelect.focus();
                }
            }

            async function handleDeleteExpense(expenseId) {
                const expenseToDelete = appState.expenseList.find(exp => exp.id === expenseId);
                if (!expenseToDelete) return;

                if (confirm(`Excluir despesa?\nCat: ${expenseToDelete.category}\nValor: ${formatCurrency(expenseToDelete.amount)}\nData: ${formatDateTime(expenseToDelete.timestamp)}`)) {
                    const result = await fetchApi(`/expenses/${expenseId}`, 'DELETE');
                    if (result) {
                        appState = result; // API retorna estado atualizado
                        updateUIFromState();
                        alert("Despesa excluída.");
                    }
                }
            }

            async function archivePeriodData() {
                // Esta função agora corresponde a arquivar o período ATUAL (parcial)
                if (!appState.currentCycle || !appState.currentCycle.is_active) {
                     alert("Nenhum ciclo ativo."); return;
                }
                 if (!(appState.currentCycle.current_period_earnings > 0 || appState.currentCycle.current_period_race_count > 0)) {
                     alert("Sem dados neste período para arquivar."); return;
                 }

                if (!confirm("Arquivar dados de ganhos/corridas do período atual?\n\nIsso salvará um registro parcial e zerará os contadores de ganhos/corridas deste ciclo.\nO ciclo de gasolina/despesas continuará ativo.")) {
                    return;
                }

                const note = prompt("Adicionar uma nota a este período arquivado? (Opcional)") || '';
                const result = await fetchApi('/archives/period', 'POST', { note: note });

                if (result) {
                    appState = result; // API retorna estado atualizado
                    updateUIFromState();
                    alert("Período arquivado! Ganhos/corridas zerados para o ciclo atual.");
                }
            }

            // Renomeado de handleStartNewCycle para corresponder à ação
            async function startNewCycle() {
                 if (appState.currentCycle?.is_active) {
                     alert("ERRO: Finalize o ciclo atual antes de iniciar um novo.");
                     return;
                 }

                let newGasCost = 0;
                let newFuelPrice = null; // Permitir nulo
                let newStartKM = null;   // Permitir nulo

                let gasCostStr = prompt("--- INICIAR NOVO CICLO ---\n\n1/3: Valor TOTAL gasto com gasolina?\n(Ex: 270,00)", "");
                if (gasCostStr === null) { alert("Início cancelado."); return; }
                gasCostStr = gasCostStr.replace(',', '.');
                newGasCost = parseFloat(gasCostStr);
                while (isNaN(newGasCost) || newGasCost <= 0) {
                    gasCostStr = prompt("Valor inválido!\n\n1/3: Valor TOTAL gasto com gasolina?\n(Ex: 270,00 - Obrigatório)", "");
                    if (gasCostStr === null) { alert("Início cancelado."); return; }
                    gasCostStr = gasCostStr.replace(',', '.');
                    newGasCost = parseFloat(gasCostStr);
                }

                const fuelPriceStr = prompt(`2/3: PREÇO POR LITRO da gasolina?\n(Ex: 6.49 - Opcional, para KM/L)`, "");
                if (fuelPriceStr !== null && fuelPriceStr.trim() !== '') {
                    const price = parseFloat(fuelPriceStr.replace(',', '.'));
                    if (!isNaN(price) && price > 0) {
                        newFuelPrice = price;
                    } else {
                        alert("Preço/litro inválido. Cálculo de KM/L ficará indisponível (N/A).");
                    }
                }

                const startKmStr = prompt(`3/3: QUILOMETRAGEM INICIAL?\n(Ex: 80000 - Opcional, para KM rodados)`, "");
                if (startKmStr !== null && startKmStr.trim() !== '') {
                    const km = parseInt(startKmStr.replace(/\D/g, ''), 10);
                    if (!isNaN(km) && km >= 0) {
                        newStartKM = km;
                    } else {
                        alert("KM inicial inválido. Cálculo de KM rodados ficará indisponível (N/A).");
                    }
                }

                const payload = {
                    gas_cost: newGasCost,
                    start_km: newStartKM,
                    fuel_price: newFuelPrice
                };

                const result = await fetchApi('/cycles/start', 'POST', payload);

                if (result) {
                    // A API de start retorna apenas o novo ciclo, precisamos recarregar o estado completo
                    await loadInitialData(); // Recarrega todo o estado
                     alert(`--- NOVO CICLO INICIADO ---\nGasolina: ${formatCurrency(appState.currentCycle.gas_cost)}\nPreço/L: ${appState.currentCycle.fuel_price_per_liter ? formatCurrency(appState.currentCycle.fuel_price_per_liter) : NA_DISPLAY}\nKM Inicial: ${appState.currentCycle.start_km ? appState.currentCycle.start_km + ' KM' : 'Não definido'}`);
                    earningTotalInput.focus();
                }
            }

            // Renomeado de handleFinalizeCycle
            async function finalizeCycle() {
                 if (!appState.currentCycle?.is_active) {
                     alert("ERRO: Nenhum ciclo ativo para finalizar.");
                     return;
                 }

                let confirmedFinalKM = appState.currentCycle.end_km; // Usa o valor atual se já existir
                const startKM = appState.currentCycle.start_km;

                // Solicita KM Final apenas se não definido ou se for menor que inicial
                if (confirmedFinalKM === null || (startKM !== null && confirmedFinalKM < startKM) ) {
                    let promptMessage = "--- FINALIZAR CICLO ---\n\nInsira a QUILOMETRAGEM FINAL:";
                    let defaultValue = "";
                    if (startKM !== null) {
                        promptMessage += `\n(KM Inicial: ${startKM})`;
                        defaultValue = confirmedFinalKM !== null ? confirmedFinalKM.toString() : startKM.toString();
                        promptMessage += "\n\n(Obrigatório se KM Inicial foi definida)";
                    } else {
                         promptMessage += "\n(KM Inicial não definida)";
                         defaultValue = confirmedFinalKM !== null ? confirmedFinalKM.toString() : '';
                    }

                    let validKm = false;
                    while (!validKm) {
                        const kmFinalStr = prompt(promptMessage, defaultValue);
                        if (kmFinalStr === null) { // Cancelou
                            if (startKM !== null && !confirm("Cancelou a inserção do KM Final.\nCálculos de KM podem ficar incorretos/zerados.\nFinalizar mesmo assim?")) {
                                alert("Finalização cancelada."); return;
                            } else {
                                // Permite finalizar sem KM final ou com KM final inválido (backend usará start_km como default)
                                confirmedFinalKM = startKM; // Ou null se startKM for null
                                validKm = true;
                            }
                        } else { // Inseriu algo
                             const kmNum = parseInt(kmFinalStr.replace(/\D/g, ''), 10);
                             if (!isNaN(kmNum)) {
                                 if (startKM !== null && kmNum < startKM) {
                                     alert(`KM Final (${kmNum}) não pode ser menor que Inicial (${startKM}).`);
                                     defaultValue = kmFinalStr; // Mantém o valor inválido para correção
                                 } else {
                                     confirmedFinalKM = kmNum; // KM válido
                                     validKm = true;
                                 }
                             } else {
                                 alert(`Valor inválido para KM final.`);
                                defaultValue = kmFinalStr;
                             }
                         }
                    } // Fim while
                 } // Fim if precisa de KM

                const note = prompt("Adicionar uma nota a este ciclo arquivado? (Opcional)") || '';

                const payload = {
                    end_km: confirmedFinalKM,
                    note: note
                };

                const result = await fetchApi('/cycles/finalize', 'POST', payload);

                if (result) {
                    appState = result; // API retorna o novo estado (ciclo inativo, listas vazias, arquivos atualizados)
                    updateUIFromState();
                    alert("Ciclo finalizado e arquivado!");
                }
            }

             // Funções de Edição (agora chamam a API)
             async function editCycleField(fieldName, promptMessage, currentValueFormatted, inputType = 'number') {
                 if (!appState.currentCycle?.is_active) {
                     alert("Nenhum ciclo ativo.");
                     return;
                 }

                 const newValueStr = prompt(promptMessage, currentValueFormatted);
                 if (newValueStr === null) return; // Cancelado

                 let newValue;
                 let payload = {};

                 try {
                     if (inputType === 'km') {
                         newValue = parseInt(newValueStr.replace(/\D/g, ''), 10);
                         if (isNaN(newValue) || newValue < 0) throw new Error("Valor de KM inválido.");
                         // Validação extra (inicio > fim ou fim < inicio) será feita no backend
                     } else { // Assume moeda/decimal
                         newValue = parseFloat(newValueStr.replace(',', '.'));
                          if (isNaN(newValue) || newValue < 0) throw new Error("Valor numérico inválido.");
                     }

                    // Prepara o payload correto para a API unificada
                    if (fieldName === 'gas_cost') payload.gas_cost = newValue;
                    else if (fieldName === 'fuel_price') payload.fuel_price = newValue > 0 ? newValue : null; // Envia null se zerado
                    else if (fieldName === 'start_km') payload.start_km = newValue;
                    else if (fieldName === 'end_km') payload.end_km = newValue;
                    else return; // Campo desconhecido

                     // Chama a API unificada
                     const result = await fetchApi('/cycles/current', 'PUT', payload);

                     if (result) {
                         appState = result; // Atualiza com a resposta
                         updateUIFromState();
                         alert(`Campo atualizado com sucesso.`);
                     }
                 } catch (error) {
                     alert(`Erro: ${error.message}`);
                 }
             }

            function editCurrentGasCost() {
                 const currentVal = appState.currentCycle?.gas_cost || 0;
                 editCycleField('gas_cost', `Corrigir gasto com GASOLINA:\n(Atual: ${formatCurrency(currentVal)})`, currentVal.toFixed(2).replace('.', ','));
            }
            function editCurrentFuelPrice() {
                 const currentVal = appState.currentCycle?.fuel_price_per_liter || 0;
                 const formattedVal = currentVal > 0 ? currentVal.toFixed(2).replace('.', ',') : '';
                 editCycleField('fuel_price', `Corrigir PREÇO POR LITRO:\n(Atual: ${formatCurrency(currentVal) || NA_DISPLAY})`, formattedVal);
            }
            function editCycleStartKM() {
                 const currentVal = appState.currentCycle?.start_km || '';
                 editCycleField('start_km', `Corrigir KM INICIAL:\n(Atual: ${currentVal || 'N/D'})`, String(currentVal), 'km');
            }
            function editCycleEndKM() {
                 const currentVal = appState.currentCycle?.end_km || '';
                 editCycleField('end_km', `Corrigir KM FINAL:\n(Atual: ${currentVal || 'N/D'})`, String(currentVal), 'km');
            }


            async function handleDeleteEntry(earningId) {
                const entryToDelete = appState.earningsList.find(e => e.id === earningId);
                 if (!entryToDelete) return;

                 if (confirm(`Excluir corrida?\nValor: ${formatCurrency(entryToDelete.amount)}\nData: ${formatDateTime(entryToDelete.timestamp)}`)) {
                    const result = await fetchApi(`/earnings/${earningId}`, 'DELETE');
                     if (result) {
                        appState = result; // API retorna estado atualizado
                         updateUIFromState();
                         alert("Corrida excluída.");
                     }
                 }
             }

            async function handleEditEntry(earningId) {
                 const entryToEdit = appState.earningsList.find(e => e.id === earningId);
                 if (!entryToEdit) return;

                 const oldAmount = entryToEdit.amount;
                 const newValueStr = prompt(`Editar valor da corrida:\n(Atual: ${formatCurrency(oldAmount)}, Data: ${formatDateTime(entryToEdit.timestamp)})`, oldAmount.toFixed(2).replace('.', ','));
                 if (newValueStr === null) return;

                 const newAmount = parseFloat(newValueStr.replace(',', '.'));
                 if (isNaN(newAmount) || newAmount < 0) {
                     alert("Valor inválido."); return;
                 }
                 if (newAmount === oldAmount) return;

                 const result = await fetchApi(`/earnings/${earningId}`, 'PUT', { amount: newAmount });

                 if (result) {
                     appState = result; // API retorna estado atualizado
                     updateUIFromState();
                     alert("Valor da corrida atualizado.");
                 }
             }

            function showArchiveDetails(archiveId) {
                // Encontra o arquivo no estado local pelo ID do banco
                const archive = appState.archives.find(a => a.db_id === archiveId);
                if (!archive) {
                    console.error("Arquivo não encontrado no estado local:", archiveId);
                    alert("Erro ao carregar detalhes do arquivo.");
                    return;
                }
                currentArchiveIndex = archiveId; // Guarda o ID para possível exclusão

                const isFullCycle = archive.archiveType === "Ciclo Completo";
                const archiveDate = formatDateTime(archive.archiveDate);
                const endDate = formatDateTime(archive.periodEndDate || archive.archiveDate);
                const earnings = parseArchivedValue(isFullCycle ? archive.cycleEarnings : archive.periodEarnings);
                const races = parseArchivedValue(isFullCycle ? archive.cycleRaceCount : archive.periodRaceCount);
                const gas = parseArchivedValue(isFullCycle ? archive.gasCost : archive.gasCostSnapshot);
                const profit = parseArchivedValue(isFullCycle ? archive.summary_profit : archive.cycleProfitSnapshot);
                const note = archive.note || '';
                const profitClass = profit >= 0 ? 'positive' : 'negative';
                const earningsDetails = archive.earningsDetails || []; // Detalhes das corridas DENTRO do arquivo JSON
                const expensesList = archive.expensesList || []; // Detalhes das despesas DENTRO do arquivo JSON (se ciclo completo)

                modalTitleSpan.textContent = `Detalhes: ${archive.archiveType} (${endDate})`;

                let summaryHTML = `<p><strong>Tipo:</strong> ${archive.archiveType}</p>`;
                summaryHTML += `<p><strong>Arquivado:</strong> ${archiveDate}</p>`;
                summaryHTML += `<p><strong>Encerrado:</strong> ${endDate}</p>`;
                summaryHTML += `<p><strong>${isFullCycle ? 'Ganhos Totais:' : 'Ganhos (Período):'}</strong> ${formatCurrency(earnings)}</p>`;
                summaryHTML += `<p><strong>${isFullCycle ? 'Corridas Totais:' : 'Corridas (Período):'}</strong> ${races}</p>`;
                summaryHTML += `<p><strong>Gasto Gasolina:</strong> ${formatCurrency(gas)}</p>`;

                if (isFullCycle) {
                    const otherExpenses = parseArchivedValue(archive.summary_totalOtherExpenses);
                    const kmDriven = parseArchivedValue(archive.summary_kmDriven);
                    const kmPerLiter = archive.summary_kmPerLiter || NA_DISPLAY;
                    const costPerKm = archive.summary_costPerKm || NA_DISPLAY; // Vem formatado como string
                    const fuelPrice = parseArchivedValue(archive.fuelPricePerLiter);
                    const startKm = parseArchivedValue(archive.startKM);
                    const endKm = parseArchivedValue(archive.endKM);
                    if (otherExpenses > 0) summaryHTML += `<p><strong>Outras Despesas:</strong> ${formatCurrency(otherExpenses)}</p>`;
                    if (fuelPrice > 0) summaryHTML += `<p><strong>Preço Gasolina (L):</strong> ${formatCurrency(fuelPrice)}</p>`;
                    if (kmDriven > 0) {
                        summaryHTML += `<p><strong>KM Rodados:</strong> ${kmDriven} KM (${startKm} - ${endKm})</p>`;
                        summaryHTML += `<p><strong>KM / Litro:</strong> ${kmPerLiter}</p>`; // String N/A ou formatado
                        summaryHTML += `<p><strong>Custo / KM:</strong> R$ ${costPerKm}</p>`; // String N/A ou formatado (adiciona R$)
                    }
                }
                summaryHTML += `<p><strong>${isFullCycle ? 'Lucro Líquido:' : 'Lucro Ciclo (Snap.):'}</strong> <span class="profit-value ${profitClass}">${formatCurrency(profit)}</span></p>`;
                if (note) {
                    summaryHTML += `<p><strong>Nota:</strong><span class="modal-note">${note}</span></p>`;
                }
                modalSummaryDiv.innerHTML = summaryHTML;

                // Preenche tabela de corridas (se houver detalhes)
                modalTbody.innerHTML = ''; // Limpa antes
                if (earningsDetails.length > 0) {
                    earningsDetails.forEach(earning => {
                        const row = modalTbody.insertRow();
                        row.insertCell().textContent = formatDateTime(earning.timestamp);
                        const valueCell = row.insertCell();
                        valueCell.textContent = formatCurrency(earning.amount || 0);
                    });
                    modalRunsTitle.style.display = 'flex';
                    modalDetailsTableContainer.style.display = 'block';
                } else {
                    modalRunsTitle.style.display = 'none';
                    modalDetailsTableContainer.style.display = 'none';
                }

                // Preenche tabela de despesas (se for ciclo completo e houver despesas)
                modalExpensesTbody.innerHTML = ''; // Limpa antes
                if (isFullCycle && expensesList.length > 0) {
                     expensesList.forEach(expense => {
                         const row = modalExpensesTbody.insertRow();
                         row.insertCell().textContent = expense.category;
                         row.insertCell().textContent = formatDateTime(expense.timestamp); // Já vem com hora
                         const valueCell = row.insertCell();
                         valueCell.textContent = formatCurrency(expense.amount);
                     });
                    modalExpensesTitle.style.display = 'flex';
                     modalExpensesTableContainer.style.display = 'block';
                 } else {
                    modalExpensesTitle.style.display = 'none';
                     modalExpensesTableContainer.style.display = 'none';
                 }

                modal.style.display = 'block';
            }

            function closeModal() {
                modal.style.display = 'none';
                currentArchiveIndex = -1; // Reseta o índice do modal
            }

            async function handleDeleteArchive(archiveId) {
                 const archiveToDelete = appState.archives.find(a => a.db_id === archiveId);
                 if (!archiveToDelete) return;

                 const archiveDate = formatDateTime(archiveToDelete.archiveDate);
                 const archiveType = archiveToDelete.archiveType || '?';
                 let confirmationMessage = `Excluir permanentemente ${archiveType} de ${archiveDate}?\n\nIrreversível.`;

                 // Aviso sobre não reajustar ciclo ativo (simplificação)
                 if (archiveToDelete.archiveType === "Período Parcial" && appState.currentCycle?.is_active) {
                     confirmationMessage += `\n\n(Nota: A exclusão deste arquivo NÃO reajustará os totais do ciclo atualmente ativo).`;
                 }

                 if (!confirm(confirmationMessage)) return;

                 const result = await fetchApi(`/archives/${archiveId}`, 'DELETE');

                 if (result) {
                     appState.archives = result.archives; // API retorna a lista atualizada
                     updateUIFromState(); // Atualiza lista e gráfico
                     alert(result.message || "Arquivo excluído.");
                     if (currentArchiveIndex === archiveId) {
                        closeModal(); // Fecha o modal se o arquivo excluído estava aberto
                     }
                 }
            }

            async function handleResetApplication() {
                 if (!confirm("⚠️ ATENÇÃO! ⚠️\n\nApagar TODOS os dados do SERVIDOR?\n\nIRREVERSÍVEL!")) return;
                 if (!confirm("‼️ ÚLTIMA CHANCE! ‼️\n\nCONFIRMAR exclusão total e permanente de TODOS os ciclos, corridas, despesas e arquivos?")) return;

                 // Chama a API de reset
                 const result = await fetchApi('/reset', 'POST');

                 if (result) {
                     alert(result.message || "Dados resetados no servidor.");
                     // Recarrega o estado inicial do frontend
                     await loadInitialData();
                 }
                 // Se falhar, o erro é mostrado pelo fetchApi
             }

             // --- Simulador (Lógica mantida no frontend) ---
             function getCostPerKmForSimulation() {
                 // 1. Tenta pegar do ciclo atual COMPLETO (com KM final definido)
                 const cycle = appState.currentCycle;
                 if (cycle && cycle.is_active && cycle.end_km !== null && cycle.end_km >= (cycle.start_km || 0)) {
                     const kmDriven = calculateKmDriven(cycle.start_km, cycle.end_km);
                     const totalOtherExpenses = getTotalOtherExpenses();
                     const costKmCurrent = calculateCostPerKmValue(cycle.gas_cost, totalOtherExpenses, kmDriven);
                     if (costKmCurrent !== null && costKmCurrent > 0) {
                          // console.log("Simulador usando Custo/KM do ciclo ATUAL finalizado.");
                          return { value: costKmCurrent, source: 'current_cycle_temp', date: null };
                      }
                 }

                 // 2. Tenta pegar do último arquivo de Ciclo Completo
                 const completedCycles = appState.archives
                    .filter(a => a.archiveType === 'Ciclo Completo' && a.summary_costPerKm && a.summary_costPerKm !== NA_DISPLAY)
                    .sort((a, b) => new Date(b.archiveDate) - new Date(a.archiveDate)); // Mais recente primeiro

                 if (completedCycles.length > 0) {
                     const lastCompleted = completedCycles[0];
                     // summary_costPerKm vem como string formatada do backend
                     const costKmValue = parseCurrencyString(lastCompleted.summary_costPerKm);
                     if (costKmValue !== null && costKmValue > 0) {
                        // console.log("Simulador usando Custo/KM do último ciclo COMPLETO arquivado.");
                         return { value: costKmValue, source: 'last_completed', date: formatDateTime(lastCompleted.periodEndDate || lastCompleted.archiveDate, false) };
                     }
                 }
                 // console.log("Simulador: Custo/KM não disponível.");
                 return null; // Nenhum custo/km válido encontrado
             }

             function updateSimulatorState() {
                 const costData = getCostPerKmForSimulation();
                 simulateCostBtn.disabled = (costData === null);
                 if(costData === null && simulationResultP.textContent !== '') { // Limpa resultado se ficou indisponível
                      simulationResultP.innerHTML = '';
                 }
             }

             function simulateCost() {
                 const costData = getCostPerKmForSimulation();
                 if (costData === null) {
                     simulationResultP.innerHTML = `Custo/KM indisponível.<br><span class="source-info">Finalize um ciclo com KM inicial/final ou verifique arquivos.</span>`;
                     simulationResultP.style.color = 'var(--warning-color)';
                     return;
                 }

                 const kmText = simulationKmInput.value;
                 const km = parseFloat(kmText.replace(',', '.'));
                 if (isNaN(km) || km <= 0) {
                     simulationResultP.textContent = "Insira uma distância válida em KM.";
                     simulationResultP.style.color = 'var(--danger-color)';
                     return;
                 }

                 const simulatedCost = km * costData.value;
                 let sourceInfo = '';
                 if (costData.source === 'last_completed') {
                     sourceInfo = `(Base: Último ciclo completo - ${costData.date})`;
                 } else if (costData.source === 'current_cycle_temp') {
                     sourceInfo = `(Base: Ciclo atual - Custo/KM pode mudar)`;
                 }
                 simulationResultP.innerHTML = `Custo para ${formatNumber(km, 1)} KM: ${formatCurrency(simulatedCost)}<br><span class="source-info">${sourceInfo}</span>`;
                 simulationResultP.style.color = 'var(--primary-color)';
             }


            // --- Inicialização ---
            async function loadInitialData() {
                console.log("Carregando dados iniciais da API...");
                const initialState = await fetchApi('/state');
                if (initialState) {
                    appState = initialState; // Preenche todo o estado inicial
                    console.log("Dados iniciais carregados:", appState);
                    updateUIFromState(); // Atualiza toda a UI com os dados recebidos
                } else {
                    console.error("Falha ao carregar dados iniciais. Aplicação pode não funcionar corretamente.");
                    // Poderia mostrar uma mensagem de erro mais persistente na UI
                }
            }

            // --- Bind de Eventos (Listeners) ---
            addTotalEarningBtn.addEventListener('click', addOrUpdateTotalEarning);
            earningTotalInput.addEventListener('input', () => {
                const isCycleActive = appState.currentCycle?.is_active || false;
                addTotalEarningBtn.disabled = !isCycleActive || earningTotalInput.value.trim() === '';
            });
            earningTotalInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !addTotalEarningBtn.disabled) { e.preventDefault(); addOrUpdateTotalEarning(); }});

            startNewCycleBtn.addEventListener('click', startNewCycle); // Renomeado
            finalizeCycleBtn.addEventListener('click', finalizeCycle); // Renomeado

            editCurrentGasBtn.addEventListener('click', editCurrentGasCost);
            editFuelPriceBtn.addEventListener('click', editCurrentFuelPrice);
            editStartKmBtn.addEventListener('click', editCycleStartKM);
            editEndKmBtn.addEventListener('click', editCycleEndKM);

            toggleHistoryBtn.addEventListener('click', () => toggleHistoryTable(!isHistoryVisible));
            toggleCycleContentBtn.addEventListener('click', () => toggleCycleContent(!isCycleContentVisible));
            toggleExpenseHistoryBtn.addEventListener('click', () => toggleExpenseHistoryTable(!isExpenseHistoryVisible));

            archiveHistoryBtn.addEventListener('click', archivePeriodData); // Renomeado

            addExpenseBtn.addEventListener('click', addExpense);
            expenseAmountInput.addEventListener('input', () => {
                const isCycleActive = appState.currentCycle?.is_active || false;
                addExpenseBtn.disabled = !isCycleActive || expenseAmountInput.value.trim() === '';
            });
            expenseAmountInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !addExpenseBtn.disabled) { e.preventDefault(); addExpense(); }});

            expensesTbody.addEventListener('click', (event) => {
                const targetButton = event.target.closest('.delete-btn');
                if (targetButton) {
                    const expenseId = parseInt(targetButton.dataset.id, 10);
                    if (!isNaN(expenseId)) {
                        handleDeleteExpense(expenseId);
                    }
                }
            });

            earningsTbody.addEventListener('click', (event) => {
                 const targetButton = event.target.closest('.action-btn');
                 if (!targetButton) return;
                 const earningId = parseInt(targetButton.dataset.id, 10);
                 if (isNaN(earningId)) return;

                 if (targetButton.classList.contains('delete-btn')) {
                     handleDeleteEntry(earningId);
                 } else if (targetButton.classList.contains('edit-btn')) {
                     handleEditEntry(earningId);
                 }
             });

            archivedListDiv.addEventListener('click', (event) => {
                 const deleteButton = event.target.closest('.delete-archive-btn');
                 const contentArea = event.target.closest('.archive-item-content');
                 if (deleteButton) {
                     const archiveId = parseInt(deleteButton.dataset.id, 10);
                     if (!isNaN(archiveId)) {
                         handleDeleteArchive(archiveId);
                     }
                 } else if (contentArea) {
                     const archiveId = parseInt(contentArea.dataset.id, 10);
                     if (!isNaN(archiveId)) {
                         showArchiveDetails(archiveId);
                     }
                 }
             });

            modalCloseBtn.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => { if (event.target == modal) { closeModal(); } });
            window.addEventListener('keydown', (event) => { if (event.key === 'Escape' && modal.style.display === 'block') { closeModal(); } });

            resetAppBtn.addEventListener('click', handleResetApplication);

            simulateCostBtn.addEventListener('click', simulateCost);
            simulationKmInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !simulateCostBtn.disabled) { e.preventDefault(); simulateCost(); }});

            // --- Inicialização da Aplicação ---
            console.log("Inicializando App Ubeleza Calculadora v4.20.5 (com Backend)...");
            initializeProfitChart();
            initializeArchivedStatsChart();
            loadInitialData(); // Busca dados da API ao carregar
            toggleCycleContent(isCycleContentVisible, false); // Aplica estado da UI
            toggleHistoryTable(isHistoryVisible, false);
            toggleExpenseHistoryTable(isExpenseHistoryVisible, false);
            console.log("App inicializado, aguardando dados da API...");

        });
    </script>

</body>
</html>